<html>
<head>

<!--
Generated by:
https://github.com/pythonbyexample/PBE/tree/master/code/jstmovie.py
 -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js" type="text/javascript"></script>
<script src="jquery-1.8.3.min.js" type="text/javascript"></script>
<script>


(function($, name) {
/* jQuery typewriter plugin
    2012-11-15
    https://github.com/bergus */
    $[name+"Defaults"] = {
        framerate: 2500/60,
        group: /.{0,2}/g // 2: Number of chars per frame
    };
    $.fn[name] = function(options, callback) {
        if (typeof options != 'object') callback=options, options={};

        return this.each(function() {
            var el = $(this),
                conf = $.extend({}, $[name+"Defaults"], options);
            el.queue("fx", function(next) {
                animateNode(this, conf, typeof callback == 'function'
                  ? function() { callback.call(el[0]); next(); }
                  : next
                );
                el.show();
            });
        });
    };
    function chunk(text, conf) {
        // splitting the text into parts (http://stackoverflow.com/a/11657799/1048572)
        return text.match(conf.group);
    }
    function timeout(callback, conf) {
        // set up the timeout
        // want to randomize? Have a look at http://jsfiddle.net/pZb8W/2/ for possible implementation
        setTimeout(callback, conf.framerate);
    }
    function animateNode(element, conf, callback) {
        var pieces = [];
        if (element.nodeType==1 && element.hasChildNodes()) {
            while (element.hasChildNodes())
                pieces.push(element.removeChild(element.firstChild));
            (function childStep() {
                if (pieces.length) {
                    var piece = pieces.shift();
                    animateNode(piece, conf, childStep);
                    element.appendChild(piece);
                } else
                    callback();
            })();
        } else if (element.nodeType==3) {
            pieces = chunk(element.data, conf);
            element.data = "";
            (function addText(){
                element.data += pieces.shift();
                timeout(pieces.length ? addText : callback, conf);
            })();
        } else // empty or special (comment etc) node
            timeout(callback, conf);
    }

})(jQuery, "typewriter");


var commands = [];
var $pause       = false;
var $type_effect = false;
var $index       = 0;
var $scrolldist  = 0;
var start_scroll = 15;

//$(document).ready( function() { });


function process_commands() {
    if ($pause) return;
    if ($index >= commands.length) {
        $("span#progress").text("100%");
        return;
    }

    var command  = commands[$index][0];
    var arg      = commands[$index][1];
    var textarea = $("div#main");
    var timeout  = 500;
    var speed    = $("input#speed").val();

    if (!speed) speed = 1;
    speed = parseInt(speed);

    //if (speed < 1 || speed > 5) speed = 1;
    speed = 1 + (speed-1) / 4;
    // final max speed should be 2 at most.
    $("span#progress").text(parseInt($index / commands.length * 100.0) + '%');
    $index++;

    if (command == "text") {
        var line = arg;
        if ($index >= start_scroll) {
            $scrolldist += 40;
            textarea.scrollTop($scrolldist);
        }

        eline = $("<span>" + line + "&nbsp;</span><br />").hide().appendTo(textarea);
        if ($type_effect) {
            eline.typewriter();
            timeout += (line.length * 40) / speed;

            // typewriter needs this to be shown fully
            $scrolldist += 40;
            textarea.scrollTop($scrolldist);
        } else {
            eline.show();
        }

        if (line.replace(/ /g, '') == '') $type_effect = false;

    } else if (command == "pause") {
        timeout = parseInt(arg, 10) * 1000;

    } else if (command == "type") {
        $type_effect = true;
    }

    if ($pause) {
        // avoid skipping scheduled command
        $index--;
        if ($index < 0) $index = 0;
    } else {
        setTimeout(process_commands, timeout / speed);
    }
}


function toggle_pause() {
    $("button#pause").text($pause ? "Pause" : "Unpause")
    $pause = $pause ? false : true;
    if (!$pause) process_commands();
}

function start() {
    //var text = $("textarea#input").text().split('\n');
    commands.length = 0;
    var text = $("textarea#input").val().split('\n');

    $.each(text, function(i, line) {
        var txt = lineBreaks(line, 90).split('\n');
        $.each(txt, function(i, line) {
            commands.push( ["text", line] );
            commands.push( ["pause", '1'] );
        });
    });

    var blank = ["text", ' ']
    var d = Array(30).join('-');
    commands.push(blank, blank, blank);
    commands.push( ["text", d + " THE END " + d]);
    commands.push(blank, blank, blank);
    process_commands();
}

function lineBreaks(text, maxlength) {
      var len = text.length;
      var pos = -1;
      var replace = true;
      for (var i=maxlength; i<len; i += maxlength)
      {
        var separator = "\n"
        for (var pos = i; text.charAt(pos) != " "; pos--)
        {
          if (pos == i-maxlength)
          {
            pos = i;
            separator += text.charAt(pos);
            len++;
            break;
          }
        }
        text = text.substring(0, pos) + separator + text.substring(pos+1, len);
        i = pos;
        replace = true;
      }
      return text;
}


</script>
<style>
    * {
        font-family: Verdana, Arial, Sans-Serif;
        font-size: 14px;
    }

    div#main {
        background:#CCCCCC none repeat scroll 0 0;
        border:3px solid #666666;
        margin:5px;
        padding:5px;
        position:relative;
        width:900px;
        height:550px;
        overflow:auto;
    }

    button#start { margin-left: 100px; }
</style>
      <!-- p { margin:10px;padding:5px;border:2px solid #666; } -->
</head>

<body>
    <button id="start" onClick="start()">Start</button>
    <button id="pause" onClick="toggle_pause()">Pause</button>
    Speed (1-5): <input id="speed" type="text" name="speed" value="1" size="3" />
    <span id="progress"></span>

    <div id="main"></div>

    <p>Input</p>
    <textarea id="input" cols="120" rows="10"></textarea>
</body>
</html>
